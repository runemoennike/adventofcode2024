let myInput = """
...........#....................#......#.....................#.#...........#......................................................
.....................................#....#.................#...............................#.....................................
..#..#.......#.............................................#.#.........................#......................#..............#....
.........................#.....#...............#.................#................................................................
.......#..........#........#.#............................................#....#.....................#..........##..#.............
.........#.....................................................#..............................................................#...
.....#..............................................................#................##.....#...........#.......#.........#.......
.......#.........#......#...............#............................#.........#.....#.....#...#..................................
.......#...............#...................#...............#............#.......................................................#.
........#.......................................................................##..#..............#...#..........................
..............#........#.......................#......#...............#..#......................#......#...#............#.........
................#................#...........................................#.....#................#..........#..................
..##....................#...........#......................#..................#.......#...........................................
..................................................................#..........#...................#................................
........................#.......#..........................#................................#.....................#...#.#.........
...............#........#...............#.##..#.#...............#...........#......................................#..............
.#.........#.#...............................................................................#..........................#...#.....
..............................#.....#.............##..............#.##....................#......#.................#....#.........
..............#.............................#........#.....#..........................................#...........#...............
...................#.................#..............#....##..#......................#..............................#....#.#.......
.............##.....................#..........#....................................#.....................#...#.#.................
.........................#..........#.......#.................................#...................................................
............#.................#.................................................#.........##....................#.........#.....#.
.#.........#.........................#..............#............#..#...........................##.........#......................
...........................#.....#...................#....#...........#.#.#...........#...................#.......................
.................#..#......#..............................................................................#...................#...
...............................#..............#...#..#......##.#.........................#........#...........#...................
........#...............##.............................................................#..........................#...............
.............#.............#.............#...................#...........#....................#...................................
##.......................................................................................#....#...........#....#...........#......
.....................#.#.......................................#.....................................#.................#..........
......................#...................................................................#.....................#............#...#
.........................#.#........................#.#................#....#....#.....#..........................................
.....................#...#.......................................#.......#.............#...................#......................
.............#...............#...............................................................................................#....
........................................................................................................#........#.........#......
.................................##....................#....#..............#.....#.....#..#....#.........................#.#.....#
.........................................................................#........#........#.........................#...#........
#...................#..........#......................#..............................#.#........................#.................
.#.....................................................................#..#.......#........................#......................
.......................#..............#..............#..#..............................#..........................................
...................................................................................................#...................#..........
...............#............#....................................#.....................#....................#.....................
............#..#.#..........#.#.......#..........................#.................#.#..........#.......#.........................
.......#....#.............................#..............................#..#........................#........#...................
........#.................#.....#.#..............................#........................#...................#..........#........
............................#........................#.........................................................#..................
....................................#.............##....................................................................#..#......
..................................................#................................................#..............#........#...##.
...........##.................#.........................#....................................................#...........#........
...........#.#..................#.......................#...#.......#................#.......##...................................
................................................#...........#........#.......................#.....................#....#.#.......
...............#........................................#............................#.....................................#......
........#...#.....#.......................................................#.#................................#.#..................
.....#............#.#...............#.#.....#....................#.#...................#...................##.........#..........#
............#.................#....................................................#...........................................#..
................#..#.....#....................................#................#...#..............................................
.....................................................................#...............#............................................
..................#...........#.....#...................#....#..............................................#.....................
.#............#...................................#.........#.........................................#...........#...............
#.......#..#...#.....#............................................................................................................
..#.........................................................##..............................#................................#....
..............................#..............#........................................................#....................#......
#.........#.........#.............#..............#............................#..........#........................#..#............
....#...........#..........................##......#.............................#.....#........................#.................
.....#.................................................................#..#.......................................................
..........................#.......#.......#..................#....................................................................
................#....................#..................#.........................................................................
..............................................#..........................#...........#.....#...........................#....#.#...
.##...............#...#...........................................................................................................
..................#..#.......................#...#..#.#.................................#.........................#...........#...
..........................................................................#....................................#..................
#...........#.............................##.....................#........#....#...#........#.....................#.....#.........
.......#.............................#...^....#..................................#.........#......................................
........#..............................#................................#.....#....##.............................................
.................#...........................#........................#..........#..........#.................#.#..........#.....#
..................................................................................................................#...............
..........#.........#........................#........................................................#........................#..
................................................................................................................#.................
....................#......................#....#.......#.....#...................................................................
................................#........................................................#.........................###............
......#..............#.#....................#............#.......................#.......................................#........
.........................#....................................#..............#.......#............................................
..............#.................#........................................................#..#.....................................
.....#.#........................#...........................................#..#.....#.................#................#......##.
................#.............#...................................................................................................
#....................#..........#..............##...#........#..#.........................#............#......#..................#
...........#..#.......#.....................#..........................................................#........#.................
...............................................#................#...........#................................#....................
.............#.......#.................#........#.............................................#...........#.......................
....................#.......#.....#.......................#.................#.............#.........................#.............
.#..............#.................................................................................................................
..#.#......................................#.................#.........#...................................#.#....................
......#..............................#........#.#..................#................#.................................#...........
..............#........................................#..........................................................................
.#...........#.........#...........#...................#................#..................................#............#..#......
.........#....#...................#..#.................................................................#....#.....................
..........#...........................#.....................................#...............#.......#...#.........................
...........#..................................#............................................................##................#....
.......................#..#.......................................................................................................
...............................................#......................#.#.#.............#..#........#...........................#.
..#.................................................#..............................#.....................................#........
..........#..#..........#...................#......................................##......#.......#........#.....#...............
.#.#...............................................##...#................#..............#.....#...................................
....................#..#...............................#..#.......#....................#....#.....................#.....#.#.......
#...................#...........#...................................................#...........................#..##.........###.
.............#.........#......#..........................#.................#......##................#...............#...#.........
........#.....................................................................................#...................................
..#...........#...................................#...................#............................#.........#.................#..
.................................................................................#................................................
.#........#.................#......................................#.....#...........#................#...........................
#...........................#..............................#....#............................................................#....
#..........#.............................................#..........#.......................................................#.....
.........#...#...#...#............................................................#....#..........#.......................#.......
.........................#.........................#........#............#..............#.....##.........................#...#....
...............................#...........#..............................................#......................#......#.........
......................#........................#..#.....................#...............................#........................#
......#...##..............................................................................................................#.......
............#.............#.#...............................................#.........#..........................#...........#....
.......................................#............#...............................................#.............................
....#........#.............................#...............#.#................................................#...................
.........#.#........................#.....#...##...#.........###............#.#.........#......#.........#................#.....#.
...........#....................#......................##...............#.......................................................#.
#......................................................#.................##....................................#........#.....#...
..#..........................##.................#...........................................#.....................................
.......................................#............#......#...#.........#......##......................................#.........
.#.......#.........................................##..............................................#.#...................#........
.................#.........#..........................##............................#..#.....#....................................
.....#....................................#......................................#.......................#...........#..#..#......
.......#......#.........#.....#........#......#.................#...........#............#..................#....#...........#....
"""

let testInput = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

let input = myInput

type Guard = { Pos: int*int; Dir: int*int }

// Part 1

let toMap (str:string) = 
    str.Trim().Split(System.Environment.NewLine)
    |> Array.map(fun s -> s |> Seq.map(fun c->
        match c with
        | '#' -> 1
        | _ -> 0
    ))
    |> array2D

let findGuard (str:string) =
    let charLines = str.Trim().Split(System.Environment.NewLine)
    let y = charLines |> Seq.findIndex(fun s -> s.Contains('^'))
    let x =  charLines[y] |> Seq.findIndex((=)'^')
    (x, y)

let isInBoundsOf (map:int[,]) (x, y) =
    x >= 0 && x < map.GetLength(1) && y >= 0 && y < map.GetLength(0)

let (|CollisionAhead|WayIsClear|) ((map:int[,]), (guard:Guard)) =
    let x, y = guard.Pos
    let dx, dy = guard.Dir
    let x', y' = (x + dx, y + dy)
    if ((x', y') |> isInBoundsOf map) && map[y', x'] = 1 then CollisionAhead
    else WayIsClear

let add t1 t2 = ((fst t1) + (fst t2), (snd t1) + (snd t2))

let rotateToNext dir =
    match dir with
    | (0, -1) -> (1, 0)
    | (1, 0) -> (0, 1)
    | (0, 1) -> (-1, 0)
    | (-1, 0) -> (0, -1)
    | _ -> invalidArg (nameof dir) "Invalid direction."

let takeSteps (map:int[,]) (initialGuard:Guard) = seq {
    let mutable guard = initialGuard
    yield guard

    let mutable prevPos = guard.Pos
    while (guard.Pos |> isInBoundsOf map) do
        guard <- 
            match (map, guard) with
            | WayIsClear -> { 
                Pos = guard.Pos |> add guard.Dir; 
                Dir = guard.Dir 
              }
            | CollisionAhead -> {
                Pos = guard.Pos;
                Dir = guard.Dir |> rotateToNext
              }
        if guard.Pos <> prevPos 
            && (guard.Pos |> isInBoundsOf map) 
            then yield guard
        prevPos <- guard.Pos
}

let map = input |> toMap
let guard = input |> findGuard |> fun p -> { Pos = p; Dir = (0, -1) }
let steps = guard |> takeSteps map |> List.ofSeq
let distinctStepsCount = steps |> List.map _.Pos |> List.distinct |> List.length

//printfn $"%A{map}"
//printfn $"%A{steps}"
printfn $"{distinctStepsCount} {steps.Length}"


// Part 2

let doesLoop (map:int[,]) (initialGuard:Guard) = 
    let mutable history = []

    initialGuard
    |> takeSteps map
    |> Seq.exists(fun g ->
        let result = history |> List.contains g
        history <- history @ [g]
        result
    )

let copyWithBarrierAt (guard:Guard) (map:int[,]) =
    let map' = map |> Array2D.copy
    let x, y = guard.Pos
    map'[y, x] <- 1
    map'

let indexedSteps = 
    steps
    |> List.mapi(fun i g -> g, i)

let blockerPositions =
    indexedSteps 
    |> List.filter(fun (g1, i1) ->
        printfn $"checking {g1}"
        let map' = map |> copyWithBarrierAt g1
        guard |> doesLoop map'
    )
    |> List.map(fun t -> (fst t).Pos)
    |> List.except [guard.Pos]
    |> List.distinct

//blockerPositions
//    |> List.iter(fun g -> printfn $"%A{g}")

printfn $"{blockerPositions.Length}"

